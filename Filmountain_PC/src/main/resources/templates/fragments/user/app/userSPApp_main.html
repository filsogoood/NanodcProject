<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
		
<div class="content main-content" th:fragment="MainContent">
    <style>
        /* 모바일 웹뷰 최적화 메인 콘텐츠 스타일 */
        .main-content {
            padding: 70px 0 70px 0; /* 상단바와 하단바 고려한 패딩 */
            background-color: #0f172a;
            min-height: 100vh;
        }

        .dashboard-wrapper {
            padding: 12px;
        }

        /* 투자 리스트 디자인 */
        .investment-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .investment-card {
            background-color: #1e293b;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .investment-card:active {
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .investment-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .investment-title-section {
            display: flex;
            align-items: center;
        }

        .investment-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 16px;
            background-color: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .investment-details {
            flex: 1;
        }

        .investment-title {
            font-size: 16px;
            font-weight: 600;
            color: #f8fafc;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
        }

        .investment-summary {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: rgba(248, 250, 252, 0.7);
        }

        .investment-amount {
            font-weight: 500;
            color: #3b82f6;
        }

        .toggle-icon {
            color: #f8fafc;
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .toggle-icon.open {
            transform: rotate(180deg);
        }

        .investment-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0;
            margin-top: 0;
        }

        .investment-content.open {
            max-height: 500px; /* 충분히 큰 값으로 설정 */
            padding-top: 16px;
            margin-top: 8px;
            border-top: 1px solid rgba(248, 250, 252, 0.1);
        }

        .monthly-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .monthly-item {
            background-color: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .month-label {
            font-size: 14px;
            color: rgba(248, 250, 252, 0.8);
        }

        .month-value {
            font-weight: 500;
            color: #3b82f6;
            font-size: 14px;
        }

        .status-badge {
            display: none; /* 상태 배지 숨김 */
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
            background-color: rgba(16, 185, 129, 0.15);
            color: #10b981;
            margin-left: 10px;
        }

        .error-message {
            display: none;
            background-color: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            text-align: center;
            font-size: 14px;
        }


        
        /* 토큰 뱃지 - Liquidity만 표시 */
        .token-badge {
            display: none; /* 기본적으로 모든 토큰 뱃지 숨김 */
        }
        
        /* Liquidity 태그만 표시 */
        .token-badge.liquidity {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            margin-left: 4px;
            background-color: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }
        
        .loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        
        .loading-spinner {
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <div class="container-fluid app-container" id="userApp_view" style="visibility:hidden;">
        <div class="dashboard-wrapper">
            <div class="investment-list" th:if="${not #lists.isEmpty(investmentList)}">
                <th:block th:each="investment, iter : ${investmentList}">
                    <div class="investment-card" th:id="${'investment_item_' + iter.index}">
                        <div class="investment-header" th:onclick="'toggleContent(\'investment_content_' + ${iter.index} + '\')'">
                            <div class="investment-title-section">
                                <div class="investment-icon">
                                    <img th:if="${#strings.contains(#strings.toLowerCase(investment.token ?: ''), 'fil') || investment.token == null}" src="/assets/img/thumb/fil.png" alt="Fil" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                                    <img th:if="${#strings.contains(#strings.toLowerCase(investment.token ?: ''), 'ae') || #strings.contains(#strings.toLowerCase(investment.token ?: ''), 'ath')}" src="/assets/img/thumb/aethir.png" alt="Aethir" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                                </div>
                                <div class="investment-details">
                                    <h3 class="investment-title">
                                        <span th:text="${#strings.replace(investment.hw_product_name, 'Liquidity', '')}">제품명</span>
                                        <span class="status-badge" th:text="${investment.hw_status == 'active' ? '활성' : '비활성'}">활성</span>
                                        
                                        <!-- FIL이나 ATH 태그는 제거하고 Liquidity 태그만 표시 -->
                                        <span th:if="${#strings.contains(investment.hw_product_name, 'Liquidity') || #strings.contains(investment.token ?: '', 'Liquidity')}" class="token-badge liquidity">
                                            Liquidity
                                        </span>
                                    </h3>
                                    <div class="investment-summary">
                                        <span class="investment-amount" th:id="${'total_reward_' + investment.hw_product_id}">
                                            <span>계산 중...</span>
                                        </span>
                                        <span class="investment-type"> - 총 받은 리워드</span>
                                    </div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-down toggle-icon" th:id="${'toggle_icon_' + iter.index}"></i>
                        </div>
                        <div class="investment-content" th:id="${'investment_content_' + iter.index}">
                            <!-- 해당 투자에 대한 보상 내역 -->
                            <div class="monthly-list" th:id="${'reward_list_' + investment.hw_product_id}">
                                <th:block th:each="reward : ${rewardDetailList}" th:if="${reward.hw_product_id == investment.hw_product_id}">
                                    <div class="monthly-item" th:attr="data-reward=${reward.reward_fil}">
                                        <span class="month-label" th:text="${#dates.format(reward.regdate, 'yyyy년 MM월')}">2023년 01월</span>
                                        <span class="month-value" th:text="${#numbers.formatDecimal(reward.reward_fil, 1, 2) + ' ' + #strings.replace(investment.token ?: 'FIL', 'Liquidity', '')}">0.00 FIL</span>
                                    </div>
                                </th:block>
                                <!-- 보상 내역이 없을 경우 -->
                                <div class="monthly-item" th:if="${#lists.isEmpty(rewardDetailList) || !#lists.contains(rewardDetailList.![hw_product_id], investment.hw_product_id)}">
                                    <span class="month-label">보상 내역 없음</span>
                                    <span class="month-value">0.00 FIL</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </th:block>
            </div>
            
            <!-- 투자 내역이 없을 경우 -->
            <div class="error-message" id="error-message" th:style="${#lists.isEmpty(investmentList) ? 'display: block;' : 'display: none;'}">
                투자 정보를 찾을 수 없습니다. 관리자에게 문의하세요.
            </div>
            
            <!-- 오류 상태 히든 필드 -->
            <input type="hidden" th:value="${error}" id="main_error" class="hidden">
        </div>
        

    </div>

    <script>
        // 메인 콘텐츠 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 리스트 표시 애니메이션
            showDashboard();
            
            // 에러 확인
            checkForErrors();
            
            // 각 투자 항목의 총 리워드 계산
            calculateTotalRewards();
        });
        
        // 대시보드 표시 애니메이션
        function showDashboard() {
            const dashboard = document.getElementById('userApp_view');
            if (dashboard) {
                dashboard.style.visibility = 'visible';
                dashboard.style.opacity = '0';
                
                setTimeout(() => {
                    dashboard.style.transition = 'opacity 0.3s ease';
                    dashboard.style.opacity = '1';
                }, 100);
            }
        }
        
        // 투자 콘텐츠 토글
        function toggleContent(contentId) {
            const content = document.getElementById(contentId);
            const iconId = 'toggle_icon_' + contentId.split('_').pop();
            const icon = document.getElementById(iconId);
            
            // 콘텐츠 토글
            if (content.classList.contains('open')) {
                content.classList.remove('open');
                icon.classList.remove('open');
            } else {
                content.classList.add('open');
                icon.classList.add('open');
            }
        }
        

        
        // 에러 확인
        function checkForErrors() {
            const errorInput = document.getElementById('main_error');
            
            if (errorInput && errorInput.value) {
                const errorMessage = document.getElementById('error-message');
                const errorValue = errorInput.value;
                
                if (errorValue === 'No Investment' && errorMessage) {
                    errorMessage.style.display = 'block';
                } else if (errorValue === 'session closed') {
                    window.location.href = '/login';
                }
            }
        }
        
        // 각 투자의 총 리워드 계산 함수
        function calculateTotalRewards() {
            // 모든 투자 상품에 대해 처리
            const investmentCards = document.querySelectorAll('.investment-card');
            
            investmentCards.forEach(card => {
                // 상품 ID 추출
                const rewardListId = card.querySelector('.monthly-list').id;
                const productId = rewardListId.replace('reward_list_', '');
                
                // 해당 상품의 모든 월별 리워드 항목 가져오기
                const rewardItems = card.querySelectorAll('.monthly-item[data-reward]');
                
                // 총 리워드 계산
                let totalReward = 0;
                rewardItems.forEach(item => {
                    const rewardValue = parseFloat(item.getAttribute('data-reward')) || 0;
                    totalReward += rewardValue;
                });
                
                // 총 리워드 표시
                const totalRewardElement = document.getElementById('total_reward_' + productId);
                if (totalRewardElement) {
                    // 토큰 타입 추출 (현재 카드에서 사용 중인 코인 명칭)
                    let tokenType = 'FIL';
                    const monthValue = card.querySelector('.monthly-item .month-value');
                    if (monthValue) {
                        const valueText = monthValue.textContent.trim();
                        // 숫자와 공백 이후의 문자열을 코인 명칭으로 추출
                        const match = valueText.match(/[\d\.\s]+(.*)/);
                        if (match && match[1]) {
                            tokenType = match[1].trim();
                        }
                    }
                    
                    // 소수점 2자리까지 표시
                    totalRewardElement.innerHTML = 
                        `<span>${totalReward.toFixed(2)}</span> <span>${tokenType}</span>`;
                }
            });
        }
    </script>
</div>
    
</html>